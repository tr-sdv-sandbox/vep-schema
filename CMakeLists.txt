# VEP Schema - DDS IDL Library
#
# This library provides pre-compiled DDS types from IFEX definitions.
# The C/H files are pre-generated by generate-all.sh using idlc.
#
# Usage (as subdirectory):
#   add_subdirectory(components/vep-schema)
#   target_link_libraries(my_target vep_idl)
#
# Usage (standalone):
#   cmake -B build
#   cmake --build build
#   cmake --install build --prefix /usr/local
#
cmake_minimum_required(VERSION 3.16)
project(vep-schema VERSION 0.1.0 LANGUAGES C CXX)

# Find CycloneDDS for ddsc library
find_package(CycloneDDS REQUIRED)

# Generated C source directory
set(VEP_SCHEMA_GENERATED_C_DIR "${CMAKE_CURRENT_SOURCE_DIR}/generated/c")

# Check if generated files exist
if(NOT EXISTS "${VEP_SCHEMA_GENERATED_C_DIR}/types.h")
    message(FATAL_ERROR
        "Generated C/H files not found in ${VEP_SCHEMA_GENERATED_C_DIR}\n"
        "Run ./generate-all.sh to generate them first.")
endif()

# Collect all generated source files
set(VEP_IDL_SOURCES
    ${VEP_SCHEMA_GENERATED_C_DIR}/types.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/vss-signal.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/avtp.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/otel-metrics.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/otel-logs.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/diagnostics.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/events.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/opaque.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/security.c
    ${VEP_SCHEMA_GENERATED_C_DIR}/uds-dtc.c
)

# Build static library
add_library(vep_idl STATIC ${VEP_IDL_SOURCES})

# Ensure C linkage
set_target_properties(vep_idl PROPERTIES LINKER_LANGUAGE C)

# Include directory for headers
target_include_directories(vep_idl PUBLIC
    $<BUILD_INTERFACE:${VEP_SCHEMA_GENERATED_C_DIR}>
    $<INSTALL_INTERFACE:include/vep/idl>
)

# Link against CycloneDDS
target_link_libraries(vep_idl PUBLIC CycloneDDS::ddsc)

# Alias for namespaced access
add_library(vep::idl ALIAS vep_idl)

# ==============================================================================
# Installation
# ==============================================================================

include(GNUInstallDirs)

# Install library
install(TARGETS vep_idl
    EXPORT vep-schema-targets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

# Install headers
install(
    DIRECTORY ${VEP_SCHEMA_GENERATED_C_DIR}/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/vep/idl
    FILES_MATCHING PATTERN "*.h"
)

# Export configuration
install(EXPORT vep-schema-targets
    FILE vep-schema-targets.cmake
    NAMESPACE vep::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/vep-schema
)

# Package config
include(CMakePackageConfigHelpers)

configure_package_config_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake/vep-schema-config.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/vep-schema-config.cmake
    INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/vep-schema
)

write_basic_package_version_file(
    ${CMAKE_CURRENT_BINARY_DIR}/vep-schema-config-version.cmake
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

install(FILES
    ${CMAKE_CURRENT_BINARY_DIR}/vep-schema-config.cmake
    ${CMAKE_CURRENT_BINARY_DIR}/vep-schema-config-version.cmake
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/vep-schema
)

# ==============================================================================
# Summary
# ==============================================================================

message(STATUS "")
message(STATUS "=== VEP Schema Build Configuration ===")
message(STATUS "Generated C sources: ${VEP_SCHEMA_GENERATED_C_DIR}")
message(STATUS "CycloneDDS version: ${CycloneDDS_VERSION}")
message(STATUS "")
message(STATUS "Library:")
message(STATUS "  - vep_idl (static library with all DDS types)")
message(STATUS "")
